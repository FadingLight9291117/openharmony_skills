{
  "name": "混淆配置生成器",
  "description": "自动扫描代码并生成混淆配置文件。只保留外部 API 和序列化字段，不保留内部工具函数、常量值、映射函数和服务类。",
  "version": "1.0.0",
  "category": "代码混淆",
  "tags": ["obfuscation", "配置生成", "自动化", "代码扫描"],
  "input_schema": {
    "type": "object",
    "properties": {
      "projectPath": {
        "type": "string",
        "description": "项目根目录路径",
        "default": "./"
      },
      "indexFile": {
        "type": "string",
        "description": "主入口文件路径",
        "default": "src/index.ts"
      },
      "outputFile": {
        "type": "string",
        "description": "输出配置文件路径",
        "default": "obfuscation-rules.txt"
      },
      "projectType": {
        "type": "string",
        "enum": ["sdk", "app", "har"],
        "description": "项目类型：SDK、应用或 HAR 包",
        "default": "sdk"
      },
      "enableOptions": {
        "type": "object",
        "properties": {
          "propertyObfuscation": {
            "type": "boolean",
            "default": true
          },
          "toplevelObfuscation": {
            "type": "boolean",
            "default": true
          },
          "filenameObfuscation": {
            "type": "boolean",
            "default": true
          },
          "exportObfuscation": {
            "type": "boolean",
            "default": true
          }
        }
      }
    },
    "required": ["projectPath", "indexFile"]
  },
  "steps": [
    {
      "step": 1,
      "name": "扫描外部 API",
      "description": "读取主入口文件，提取所有 export 的类、接口、函数。只保留从主入口文件直接导出的 API，不保留内部工具函数。",
      "actions": [
        "读取主入口文件（如 Index.ets 或 index.ts）",
        "提取所有 export 的类、接口、函数",
        "识别配置接口及其所有字段",
        "过滤掉内部工具函数（仅保留从主入口文件直接导出的 API）",
        "生成外部 API 保留列表"
      ]
    },
    {
      "step": 2,
      "name": "扫描序列化类型",
      "description": "搜索 JSON.stringify/parse 使用，识别类型定义文件，判断是否整个文件需要保留。注意：如果类型已经通过 -keep 文件保留，就不需要再单独列出字段名（如 BaseInfoData、EventInfoParams 等），-keep 会自动保留文件中的所有类型和字段",
      "actions": [
        "搜索项目中所有 JSON.stringify() 和 JSON.parse() 的使用",
        "识别相关的类型定义文件",
        "判断是否整个文件需要保留（推荐使用 -keep）",
        "记录已通过 -keep 保留的文件，避免后续重复列出字段",
        "生成文件保留列表"
      ]
    },
    {
      "step": 3,
      "name": "扫描对象字面量",
      "description": "搜索对象字面量模式，识别用于 JSON 序列化和 HTTP 请求的字段",
      "actions": [
        "搜索对象字面量模式 { field: value }",
        "识别用于 JSON 序列化的字段",
        "识别用于 HTTP 请求的字段",
        "生成字段保留列表"
      ]
    },
    {
      "step": 4,
      "name": "扫描日志字段",
      "description": "搜索 logger.info/warn/error 调用，提取日志对象字段，过滤 debug 级别日志",
      "actions": [
        "搜索 logger.info/warn/error 调用",
        "提取日志对象中的字段名",
        "过滤 debug 级别日志（通常不需要保留）",
        "生成日志字段保留列表"
      ]
    },
    {
      "step": 5,
      "name": "生成配置文件",
      "description": "生成混淆配置文件。不包含内部工具函数、常量值/映射函数、内部服务类、枚举类型名、内部接口和已通过 -keep 文件保留的字段。",
      "actions": [
        "使用配置模板生成文件头部",
        "添加混淆选项启用配置",
        "添加外部 API 保留配置（仅从主入口文件导出的）",
        "添加配置接口保留配置",
        "添加数据序列化文件保留配置（使用 -keep 保留整个文件）",
        "添加对象字面量字段保留配置（仅保留未通过 -keep 文件覆盖的字段）",
        "添加日志字段保留配置",
        "过滤掉已通过 -keep 文件保留的字段（避免重复）",
        "过滤掉内部工具函数、常量值/映射函数和内部服务类（不添加到配置中）",
        "过滤掉枚举类型名（序列化时使用数字值，不是枚举名）",
        "过滤掉内部接口（如 NetworkClient 等，不是外部 API）",
        "生成完整的 obfuscation-rules.txt 文件"
      ]
    }
  ],
  "output_format": {
    "type": "file",
    "format": "plaintext",
    "template": "# ============================================================\n# 自动生成的混淆配置\n# 生成时间: {timestamp}\n# 项目类型: {projectType}\n# ============================================================\n\n# 启用混淆\n-enable-property-obfuscation\n-enable-toplevel-obfuscation\n-enable-filename-obfuscation\n-enable-export-obfuscation\n\n# ============================================================\n# 1. 外部 API\n# ============================================================\n-keep-global-name\n{externalAPIs}\n\n# ============================================================\n# 2. 外部配置接口\n# ============================================================\n-keep-global-name\n{configInterfaces}\n\n# ============================================================\n# 3. 数据序列化类型文件\n# ============================================================\n{serializationFiles}\n\n# ============================================================\n# 4. 对象字面量字段\n# ============================================================\n-keep-global-name\n{objectLiteralFields}\n\n# ============================================================\n# 5. 日志输出字段\n# ============================================================\n-keep-global-name\n{logFields}"
  },
  "examples": [
    {
      "input": {
        "projectPath": "./kapm_demo",
        "indexFile": "src/index.ts",
        "outputFile": "obfuscation-rules.txt",
        "projectType": "sdk"
      },
      "description": "为 KAPM SDK 项目生成混淆配置"
    }
  ],
  "rules": {
    "must_keep": [
      "从主入口文件（Index.ets/index.ts）直接导出的类、接口、函数",
      "配置接口的所有字段（用于对象字面量传参）",
      "用于 JSON 序列化的类型定义文件（使用 -keep 保留整个文件）",
      "对象字面量中的字段名（用于 JSON 序列化和 HTTP 请求）",
      "非 debug 级别日志中的对象字段名"
    ],
    "must_not_keep": [
      "内部工具函数（如 getLogger、safeFileOperation、withTiming、getFileSystem、Crypto 等）",
      "仅在内部使用的辅助函数",
      "未从主入口文件导出的函数和类",
      "通过 import/export 机制正常调用的内部函数（混淆工具会自动处理）",
      "常量值和映射函数（如 ANALY_TYPE_NAME_MAP、CRASH_BRANCH_NAME_MAP、getAnalyTypeName、getCrashBranchName 等）",
      "用于内部查找和映射的常量对象和函数",
      "内部服务类（如 APMCore、NetworkService、ReportService、CacheService 等）及其方法（如 init、getInstance、reportFile 等）",
      "仅在内部服务之间调用的类和方法",
      "枚举类型名（如 AnalyTypeEnum、Crash、AppFreeze 等，序列化时使用数字值，不是枚举名）",
      "内部接口（如 NetworkClient、SimpleResponse 等，不是外部 API）",
      "已通过 -keep 文件保留的类型字段（如 BaseInfoData、EventInfoParams 等，-keep 会自动保留文件中的所有字段，无需重复列出）"
    ],
    "reasoning": "内部工具函数、常量值、映射函数和内部服务类不是外部 API，它们的名称不会出现在 JSON 序列化或对象字面量中，也不会通过字符串动态访问。常量值返回的结果（如字符串值）会被序列化，但这些值已通过字段名间接保留。内部服务类虽然可能被外部 API（如 ApmStarter）间接调用，但服务类本身不是外部 API，不需要保留。枚举类型名不需要保留，因为序列化时使用的是数字值（如 2、22），而不是枚举名（如 Crash、AppFreeze）。如果类型已经通过 -keep 文件保留（如 -keep src/main/ets/kapm/types/uploadTypes.ets），那么该文件中的所有类型和字段都会自动保留，无需再单独列出字段名，避免重复配置。即使被混淆，也不会影响功能，因为混淆工具会保持函数调用、常量访问和类方法调用的正确性。"
  }
}

