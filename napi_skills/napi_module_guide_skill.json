{
  "name": "NAPI 模块开发指南",
  "description": "提供 HarmonyOS NAPI 模块的完整开发指南，包括项目结构、模块注册、函数实现模式、回调处理、类型转换和最佳实践。基于 apm 模块的实际代码整理。",
  "version": "1.0.0",
  "category": "Native 开发",
  "tags": [
    "napi",
    "native",
    "c++",
    "harmonyos",
    "arkts",
    "模块开发",
    "回调函数"
  ],
  "input_schema": {
    "type": "object",
    "properties": {
      "query": {
        "type": "string",
        "description": "查询内容（如：如何注册模块、如何获取参数、如何实现回调等）"
      },
      "codeSnippet": {
        "type": "string",
        "description": "代码片段（可选，用于代码审查或优化建议）"
      },
      "context": {
        "type": "string",
        "enum": [
          "project_structure",
          "module_registration",
          "function_patterns",
          "callback_handling",
          "type_conversion",
          "best_practices"
        ],
        "description": "上下文类型（可选，用于聚焦特定领域）"
      }
    },
    "required": ["query"]
  },
  "steps": [
    {
      "step": 1,
      "name": "理解查询意图",
      "description": "分析用户查询，确定需要提供的指导类型",
      "actions": [
        "分析查询内容",
        "识别查询类型（项目结构、模块注册、函数模式、回调处理等）",
        "确定是否需要代码审查"
      ]
    },
    {
      "step": 2,
      "name": "提供开发规范",
      "description": "根据查询提供相应的 NAPI 开发规范",
      "topics": {
        "project_structure": [
          "CMakeLists.txt 配置",
          "napi_init.cpp 模块注册",
          "业务逻辑 cpp 文件",
          "types/Index.d.ts 类型声明",
          "oh-package.json5 包配置"
        ],
        "module_registration": [
          "napi_module 结构定义",
          "Init 函数实现",
          "napi_property_descriptor 配置",
          "napi_define_properties 注册",
          "RegisterModule 构造函数"
        ],
        "function_patterns": [
          "无参数返回布尔值",
          "获取参数 napi_get_cb_info",
          "类型检查 napi_typeof",
          "获取数值/字符串/布尔值",
          "返回值创建",
          "抛出错误 napi_throw_error"
        ],
        "callback_handling": [
          "保存回调引用 napi_create_reference",
          "获取回调函数 napi_get_reference_value",
          "调用回调 napi_call_function",
          "handle_scope 内存管理",
          "删除引用 napi_delete_reference"
        ],
        "type_conversion": [
          "number ↔ napi_number",
          "string ↔ napi_string",
          "boolean ↔ napi_boolean",
          "null ↔ napi_null",
          "function ↔ napi_function",
          "object ↔ napi_object"
        ],
        "best_practices": [
          "线程安全（互斥锁）",
          "内存管理（handle_scope）",
          "信号处理器限制",
          "日志输出（hilog）",
          "错误处理"
        ]
      }
    },
    {
      "step": 3,
      "name": "提供代码示例",
      "description": "提供符合规范的代码示例",
      "actions": [
        "提供正确示例",
        "提供错误示例对比",
        "说明原因和注意事项"
      ]
    },
    {
      "step": 4,
      "name": "代码审查（如提供代码）",
      "description": "如果提供了代码片段，进行代码审查",
      "actions": [
        "检查语法合规性",
        "检查类型转换",
        "检查内存管理",
        "检查线程安全",
        "提供优化建议"
      ]
    }
  ],
  "coding_rules": {
    "project_structure": {
      "cmake_config": "CMakeLists.txt 中需要链接 libace_napi.z.so 和 libhilog_ndk.z.so",
      "module_name": "add_library 的名称决定 .so 文件名，如 add_library(apm SHARED ...) 生成 libapm.so",
      "types_location": "类型声明放在 src/main/cpp/types/lib{name}/ 目录下",
      "index_d_ts": "Index.d.ts 需要与 oh-package.json5 的 types 字段对应"
    },
    "module_registration": {
      "init_function": "Init 函数必须返回 exports，签名为 static napi_value Init(napi_env env, napi_value exports)",
      "property_descriptor": "napi_property_descriptor 数组定义导出的函数，格式为 { \"jsName\", nullptr, CppFunc, nullptr, nullptr, nullptr, napi_default, nullptr }",
      "register_macro": "使用 extern \"C\" __attribute__((constructor)) 定义自动注册函数",
      "module_struct": "napi_module 的 nm_modname 必须与 add_library 名称一致"
    },
    "function_patterns": {
      "signature": "所有 NAPI 函数签名为 napi_value FuncName(napi_env env, napi_callback_info info)",
      "get_args": "使用 napi_get_cb_info(env, info, &argc, args, nullptr, nullptr) 获取参数",
      "type_check": "使用 napi_typeof(env, value, &valuetype) 检查参数类型",
      "return_value": "必须返回 napi_value，使用 napi_get_boolean/napi_create_double/napi_create_string_utf8 等创建"
    },
    "callback_handling": {
      "save_env": "保存 napi_env 到全局变量，用于后续调用回调",
      "create_ref": "使用 napi_create_reference(env, callback, 1, &ref) 创建引用，引用计数为 1",
      "get_ref": "使用 napi_get_reference_value(env, ref, &callback) 获取回调函数",
      "call_func": "使用 napi_call_function(env, thisArg, callback, argc, argv, &result) 调用",
      "handle_scope": "调用回调前后使用 napi_open_handle_scope/napi_close_handle_scope 防止内存泄漏",
      "delete_ref": "不再需要时使用 napi_delete_reference(env, ref) 释放引用"
    },
    "type_conversion": {
      "to_double": "napi_get_value_double(env, value, &result)",
      "to_string": "先 napi_get_value_string_utf8(env, value, nullptr, 0, &length) 获取长度，再分配内存获取内容",
      "to_bool": "napi_get_value_bool(env, value, &result)",
      "from_double": "napi_create_double(env, value, &result)",
      "from_string": "napi_create_string_utf8(env, str, NAPI_AUTO_LENGTH, &result)",
      "from_bool": "napi_get_boolean(env, value, &result)",
      "get_null": "napi_get_null(env, &result)"
    },
    "best_practices": {
      "thread_safety": "使用 pthread_mutex_t 保护共享状态",
      "memory_management": "字符串获取后需要手动释放 new/delete",
      "signal_handler_limit": "信号处理器中不能调用 NAPI 函数，只能设置标志让主线程处理",
      "error_handling": "使用 napi_throw_error(env, nullptr, message) 抛出错误",
      "logging": "使用 OH_LOG_Print(LOG_APP, LOG_INFO, 0xFF00, tag, message) 输出日志"
    }
  },
  "code_templates": {
    "cmake_template": "cmake_minimum_required(VERSION 3.5.0)\nproject(myLib)\n\nset(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})\n\nif(DEFINED PACKAGE_FIND_FILE)\n    include(${PACKAGE_FIND_FILE})\nendif()\n\ninclude_directories(${NATIVERENDER_ROOT_PATH})\n\nadd_library(mylib SHARED napi_init.cpp business.cpp)\ntarget_link_libraries(mylib PUBLIC\n    libace_napi.z.so\n    libhilog_ndk.z.so\n)",
    "module_registration_template": "#include \"napi/native_api.h\"\n\nextern \"C\" {\n    napi_value MyFunction(napi_env env, napi_callback_info info);\n}\n\nEXTERN_C_START\nstatic napi_value Init(napi_env env, napi_value exports) {\n    napi_property_descriptor desc[] = {\n        { \"myFunction\", nullptr, MyFunction, nullptr, nullptr, nullptr, napi_default, nullptr }\n    };\n    napi_define_properties(env, exports, sizeof(desc) / sizeof(desc[0]), desc);\n    return exports;\n}\nEXTERN_C_END\n\nstatic napi_module myModule = {\n    .nm_version = 1,\n    .nm_flags = 0,\n    .nm_filename = nullptr,\n    .nm_register_func = Init,\n    .nm_modname = \"mylib\",\n    .nm_priv = ((void*)0),\n    .reserved = { 0 },\n};\n\nextern \"C\" __attribute__((constructor)) void RegisterMyModule(void) {\n    napi_module_register(&myModule);\n}",
    "function_with_args_template": "extern \"C\" napi_value Add(napi_env env, napi_callback_info info) {\n    size_t argc = 2;\n    napi_value args[2] = {nullptr};\n    napi_get_cb_info(env, info, &argc, args, nullptr, nullptr);\n    \n    double value0, value1;\n    napi_get_value_double(env, args[0], &value0);\n    napi_get_value_double(env, args[1], &value1);\n    \n    napi_value result;\n    napi_create_double(env, value0 + value1, &result);\n    return result;\n}",
    "callback_template": "static napi_env g_env = nullptr;\nstatic napi_ref g_callback_ref = nullptr;\n\nstatic void invoke_callback(const char* message) {\n    if (!g_env || !g_callback_ref) return;\n    \n    napi_handle_scope scope;\n    napi_open_handle_scope(g_env, &scope);\n    \n    napi_value callback;\n    if (napi_get_reference_value(g_env, g_callback_ref, &callback) == napi_ok) {\n        napi_value argv[1];\n        napi_create_string_utf8(g_env, message, NAPI_AUTO_LENGTH, &argv[0]);\n        \n        napi_value global, result;\n        napi_get_global(g_env, &global);\n        napi_call_function(g_env, global, callback, 1, argv, &result);\n    }\n    \n    napi_close_handle_scope(g_env, scope);\n}\n\nextern \"C\" napi_value SetCallback(napi_env env, napi_callback_info info) {\n    size_t argc = 1;\n    napi_value args[1];\n    napi_get_cb_info(env, info, &argc, args, nullptr, nullptr);\n    \n    napi_valuetype type;\n    napi_typeof(env, args[0], &type);\n    if (type != napi_function) {\n        napi_throw_error(env, nullptr, \"Expected function\");\n        return nullptr;\n    }\n    \n    if (g_callback_ref) napi_delete_reference(env, g_callback_ref);\n    g_env = env;\n    napi_create_reference(env, args[0], 1, &g_callback_ref);\n    \n    napi_value result;\n    napi_get_boolean(env, true, &result);\n    return result;\n}",
    "index_d_ts_template": "/**\n * 两数相加\n */\nexport const add: (a: number, b: number) => number;\n\n/**\n * 设置回调函数\n */\nexport const setCallback: (callback: (message: string) => void) => boolean;\n\n/**\n * 获取数据\n * @returns 数据字符串，无则返回 null\n */\nexport const getData: () => string | null;"
  },
  "type_mapping_table": {
    "number": {
      "napi_type": "napi_number",
      "create": "napi_create_double / napi_create_int32 / napi_create_int64",
      "get": "napi_get_value_double / napi_get_value_int32 / napi_get_value_int64"
    },
    "string": {
      "napi_type": "napi_string",
      "create": "napi_create_string_utf8(env, str, NAPI_AUTO_LENGTH, &result)",
      "get": "napi_get_value_string_utf8(env, value, buffer, bufferSize, &length)"
    },
    "boolean": {
      "napi_type": "napi_boolean",
      "create": "napi_get_boolean(env, value, &result)",
      "get": "napi_get_value_bool(env, value, &result)"
    },
    "null": {
      "napi_type": "napi_null",
      "create": "napi_get_null(env, &result)",
      "get": "N/A"
    },
    "undefined": {
      "napi_type": "napi_undefined",
      "create": "napi_get_undefined(env, &result)",
      "get": "N/A"
    },
    "function": {
      "napi_type": "napi_function",
      "create": "N/A (通过 napi_create_reference 保存)",
      "get": "napi_call_function(env, thisArg, func, argc, argv, &result)"
    },
    "object": {
      "napi_type": "napi_object",
      "create": "napi_create_object(env, &result)",
      "get": "napi_get_property / napi_get_named_property"
    }
  },
  "common_errors": [
    {
      "error": "信号处理器中调用 NAPI 函数导致崩溃",
      "cause": "NAPI 函数不是异步信号安全的",
      "solution": "在信号处理器中只设置标志，让主线程通过轮询检测并处理"
    },
    {
      "error": "回调函数调用失败",
      "cause": "未保存 napi_env 或 napi_ref 已被释放",
      "solution": "确保 g_env 和 g_callback_ref 在调用前有效"
    },
    {
      "error": "内存泄漏",
      "cause": "未使用 handle_scope 或未释放动态分配的内存",
      "solution": "使用 napi_open/close_handle_scope，字符串获取后记得 delete[]"
    },
    {
      "error": "模块加载失败",
      "cause": "nm_modname 与 add_library 名称不匹配",
      "solution": "确保 CMakeLists.txt 中的库名与 napi_module 的 nm_modname 一致"
    },
    {
      "error": "函数未导出",
      "cause": "未在 napi_property_descriptor 中注册",
      "solution": "在 Init 函数中添加 napi_property_descriptor 并调用 napi_define_properties"
    }
  ],
  "examples": [
    {
      "input": {
        "query": "如何创建一个返回字符串的 NAPI 函数？",
        "context": "function_patterns"
      },
      "description": "查询返回字符串的函数实现"
    },
    {
      "input": {
        "query": "如何实现从 ArkTS 传入回调函数？",
        "context": "callback_handling"
      },
      "description": "查询回调函数实现方式"
    },
    {
      "input": {
        "query": "CMakeLists.txt 怎么配置？",
        "context": "project_structure"
      },
      "description": "查询 CMake 配置"
    },
    {
      "input": {
        "codeSnippet": "extern \"C\" napi_value GetData(napi_env env, napi_callback_info info) {\n    std::string data = \"hello\";\n    return data.c_str();\n}",
        "query": "这段代码有什么问题？"
      },
      "description": "代码审查示例 - 返回值类型错误"
    }
  ]
}
