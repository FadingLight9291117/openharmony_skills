{
  "name": "OpenHarmony 单元测试指南",
  "description": "提供 OpenHarmony 单元测试的完整指南，包括测试框架使用、测试结构、断言方法、异步测试、错误处理和最佳实践。帮助开发者编写高质量的单元测试。",
  "version": "1.0.0",
  "category": "测试",
  "tags": [
    "openharmony",
    "unit-test",
    "testing",
    "hypium",
    "测试",
    "单元测试",
    "最佳实践"
  ],
  "input_schema": {
    "type": "object",
    "properties": {
      "query": {
        "type": "string",
        "description": "查询内容（如：如何编写异步测试、如何使用断言、如何测试错误处理等）"
      },
      "codeSnippet": {
        "type": "string",
        "description": "代码片段（可选，用于测试代码审查或优化建议）"
      },
      "context": {
        "type": "string",
        "enum": [
          "test_structure",
          "assertions",
          "async_testing",
          "error_handling",
          "best_practices"
        ],
        "description": "上下文类型（可选，用于聚焦特定领域）"
      }
    },
    "required": [
      "query"
    ]
  },
  "steps": [
    {
      "step": 1,
      "name": "理解测试需求",
      "description": "分析用户查询，确定需要提供的测试指导类型",
      "actions": [
        "分析查询内容",
        "识别测试类型（单元测试、异步测试、错误处理测试等）",
        "确定是否需要测试代码审查"
      ]
    },
    {
      "step": 2,
      "name": "提供测试框架指导",
      "description": "介绍 OpenHarmony 测试框架 @ohos/hypium 的使用",
      "actions": [
        "说明测试框架的基本结构",
        "介绍测试生命周期钩子（beforeAll, beforeEach, afterEach, afterAll）",
        "说明测试用例编写方法（describe, it）"
      ]
    },
    {
      "step": 3,
      "name": "提供断言方法指导",
      "description": "介绍可用的断言方法及其使用场景",
      "actions": [
        "列出所有可用的断言方法",
        "说明每个断言方法的用途和参数",
        "提供正确的使用示例"
      ]
    },
    {
      "step": 4,
      "name": "提供测试最佳实践",
      "description": "提供测试编写的最佳实践和常见模式",
      "actions": [
        "说明如何组织测试文件",
        "说明如何测试异步操作",
        "说明如何测试错误处理",
        "说明如何测试边界情况"
      ]
    }
  ],
  "context": {
    "test_framework": {
      "name": "@ohos/hypium",
      "description": "OpenHarmony 官方单元测试框架",
      "import": "import { describe, beforeAll, beforeEach, afterEach, afterAll, it, expect } from '@ohos/hypium';"
    },
    "test_structure": {
      "basic_structure": "export default function testSuite() { describe('TestSuite', () => { it('test case', 0, () => { ... }); }); }",
      "lifecycle_hooks": {
        "beforeAll": "在所有测试用例执行前运行一次，用于测试套件初始化",
        "beforeEach": "在每个测试用例执行前运行，用于测试用例准备",
        "afterEach": "在每个测试用例执行后运行，用于测试用例清理",
        "afterAll": "在所有测试用例执行后运行一次，用于测试套件清理"
      },
      "test_organization": {
        "describe": "定义测试套件，可以嵌套使用",
        "it": "定义测试用例，格式：it('test name', 0, testFunction)"
      }
    },
    "assertions": {
      "available_methods": [
        "assertEqual(expected, actual) - 断言相等",
        "assertTrue(condition) - 断言为真",
        "assertFalse(condition) - 断言为假",
        "assertNull(value) - 断言为 null",
        "assertUndefined(value) - 断言为 undefined",
        "assertNotNull(value) - 断言不为 null",
        "assertContain(str, substr) - 断言字符串包含",
        "assertLargerOrEqual(value, threshold) - 断言大于等于",
        "assertLessOrEqual(value, threshold) - 断言小于等于"
      ],
      "usage_examples": {
        "assertEqual": "expect(result).assertEqual('expected');",
        "assertTrue": "expect(condition).assertTrue();",
        "assertFalse": "expect(condition).assertFalse();",
        "assertUndefined": "expect(value).assertUndefined();",
        "assertContain": "expect(str).assertContain('substr');",
        "assertLargerOrEqual": "expect(value).assertLargerOrEqual(threshold);"
      }
    },
    "async_testing": {
      "async_functions": "测试异步函数时，使用 async/await",
      "promise_handling": "Promise 需要指定类型，例如：new Promise<void>(resolve => setTimeout(resolve, 10))",
      "example": "it('should handle async operation', 0, async () => { const result = await asyncFunction(); expect(result).assertEqual('expected'); });"
    },
    "error_handling": {
      "error_testing": "使用 try-catch 测试错误情况",
      "error_type": "catch 到的 error 是 Error 类型，需要显式转换：throw error as Error",
      "error_message": "catch 到的 error 可以直接使用 .message 属性",
      "example": "try { await functionThatThrows(); expect(true).assertFalse(); } catch (error) { expect(error instanceof Error).assertTrue(); if (error instanceof Error) { expect(error.message).assertEqual('expected error'); } }"
    },
    "test_organization": {
      "file_structure": "测试文件应放在 ohosTest/ets/test 目录下",
      "file_naming": "测试文件命名：被测试模块名.test.ets",
      "import_paths": "使用相对路径导入被测试模块，例如：import { function } from '../../../main/ets/module';",
      "test_registration": "在 List.test.ets 中注册所有测试套件"
    },
    "best_practices": {
      "test_naming": "测试用例名称应清晰描述测试内容，使用 'should ...' 格式",
      "test_isolation": "每个测试用例应该独立，不依赖其他测试用例的执行顺序",
      "test_coverage": "测试应覆盖正常流程、错误流程和边界情况",
      "test_data": "使用有意义的测试数据，避免魔法数字和字符串",
      "async_cleanup": "异步操作完成后要等待清理完成，例如：await new Promise<void>(resolve => setTimeout(resolve, 20));",
      "error_assertions": "测试错误时，先断言错误类型，再断言错误消息",
      "type_safety": "所有变量应显式指定类型，特别是从 ESObject 获取的变量",
      "promise_types": "Promise 必须指定类型，例如：Promise<void>, Promise<T>"
    }
  },
  "coding_rules": {
    "test_structure": {
      "import_statement": "必须导入 @ohos/hypium 的测试工具：import { describe, beforeAll, beforeEach, afterEach, afterAll, it, expect } from '@ohos/hypium';",
      "export_function": "测试文件必须导出默认函数：export default function testSuite() { ... }",
      "describe_nesting": "可以使用嵌套的 describe 组织相关测试",
      "it_parameters": "it 函数参数：it('test name', 0, testFunction)，第二个参数是过滤器参数，通常为 0"
    },
    "assertions": {
      "assert_equal": "使用 assertEqual 比较值：expect(actual).assertEqual(expected)",
      "assert_boolean": "使用 assertTrue/assertFalse 断言布尔值",
      "assert_null_undefined": "使用 assertNull/assertUndefined 断言空值",
      "assert_contain": "使用 assertContain 检查字符串包含",
      "assert_comparison": "使用 assertLargerOrEqual/assertLessOrEqual 进行数值比较",
      "note": "注意：没有 assertGreaterOrEqual，只有 assertLargerOrEqual"
    },
    "async_testing": {
      "async_keyword": "异步测试函数必须使用 async 关键字",
      "await_usage": "使用 await 等待异步操作完成",
      "promise_type": "Promise 必须指定类型，例如：new Promise<void>(resolve => setTimeout(resolve, 10))",
      "promise_resolve": "Promise 的 resolve 参数类型必须明确，例如：resolve => setTimeout(resolve, 10)"
    },
    "error_handling": {
      "error_catch": "catch 到的 error 就是 Error 类型，不需要类型检查",
      "error_message": "可以直接使用 error.message，不需要 error instanceof Error ? error.message : String(error)",
      "error_rethrow": "如果再次抛出错误，需要显式转换：throw error as Error",
      "error_assertion": "测试错误时，先断言 error instanceof Error，再断言 error.message"
    },
    "test_organization": {
      "file_location": "测试文件放在 ohosTest/ets/test 目录",
      "import_relative_path": "使用相对路径导入被测试模块",
      "test_registration": "在 List.test.ets 中导入并调用所有测试套件",
      "test_grouping": "使用 describe 按功能分组测试用例"
    },
    "best_practices": {
      "test_naming": "测试用例名称应清晰描述测试内容",
      "test_isolation": "每个测试用例应该独立",
      "test_coverage": "覆盖正常流程、错误流程和边界情况",
      "async_cleanup": "异步操作完成后要等待清理",
      "type_annotations": "所有变量应显式指定类型",
      "promise_types": "Promise 必须指定类型"
    }
  },
  "examples": {
    "basic_test": {
      "description": "基本测试用例",
      "code": "it('should return expected value', 0, () => { const result = function(); expect(result).assertEqual('expected'); });"
    },
    "async_test": {
      "description": "异步测试用例",
      "code": "it('should handle async operation', 0, async () => { const result = await asyncFunction(); expect(result).assertEqual('expected'); });"
    },
    "error_test": {
      "description": "错误处理测试",
      "code": "it('should throw error', 0, async () => { try { await functionThatThrows(); expect(true).assertFalse(); } catch (error) { expect(error instanceof Error).assertTrue(); if (error instanceof Error) { expect(error.message).assertEqual('expected error'); } } });"
    },
    "test_suite": {
      "description": "完整测试套件示例",
      "code": "import { describe, beforeAll, beforeEach, afterEach, afterAll, it, expect } from '@ohos/hypium';\nimport { functionToTest } from '../../../main/ets/module';\n\nexport default function testSuite() {\n  describe('TestSuite', () => {\n    beforeAll(() => {\n      // 测试套件初始化\n    });\n\n    beforeEach(() => {\n      // 每个测试用例前的准备\n    });\n\n    afterEach(() => {\n      // 每个测试用例后的清理\n    });\n\n    afterAll(() => {\n      // 测试套件结束后的清理\n    });\n\n    it('should work correctly', 0, () => {\n      const result = functionToTest();\n      expect(result).assertEqual('expected');\n    });\n  });\n}"
    }
  },
  "common_errors": {
    "wrong_assertion_method": "错误：使用 assertGreaterOrEqual，正确：使用 assertLargerOrEqual",
    "missing_promise_type": "错误：new Promise(resolve => ...)，正确：new Promise<void>(resolve => ...)",
    "missing_error_type": "错误：catch (error) { throw error; }，正确：catch (error) { throw error as Error; }",
    "missing_error_message": "错误：logger.error('msg', error)，正确：logger.error('msg', error.message)",
    "missing_async": "错误：it('test', 0, () => { await ... })，正确：it('test', 0, async () => { await ... })"
  },
  "workflows": [
    {
      "name": "编写新测试",
      "steps": [
        "在 ohosTest/ets/test 目录创建测试文件",
        "导入 @ohos/hypium 测试工具",
        "导入被测试的模块",
        "使用 describe 定义测试套件",
        "使用 it 定义测试用例",
        "使用 expect 进行断言",
        "在 List.test.ets 中注册测试套件"
      ]
    },
    {
      "name": "测试异步函数",
      "steps": [
        "测试函数使用 async 关键字",
        "使用 await 等待异步操作",
        "Promise 必须指定类型（Promise<void> 或 Promise<T>）",
        "异步清理操作要等待完成"
      ]
    },
    {
      "name": "测试错误处理",
      "steps": [
        "使用 try-catch 捕获错误",
        "断言 expect(true).assertFalse() 确保不会执行到成功分支",
        "在 catch 中先断言 error instanceof Error",
        "再断言 error.message 的内容",
        "如果需要重新抛出，使用 throw error as Error"
      ]
    }
  ]
}
